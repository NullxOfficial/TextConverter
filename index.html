<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FPS Móvil Mejorado</title>
<style>
html, body { margin:0; padding:0; overflow:hidden; width:100%; height:100%; touch-action:none; }
canvas { display:block; }

#joystick { position:fixed; bottom:15%; left:5%; width:100px; height:100px; background:rgba(200,200,200,0.5); border-radius:50%; }
#stick { position:absolute; width:50px; height:50px; background:rgba(100,100,100,0.8); border-radius:50%; top:25px; left:25px; }

#shoot { position:fixed; bottom:15%; right:5%; width:80px; height:80px; background:rgba(255,0,0,0.7); border-radius:50%; display:flex; justify-content:center; align-items:center; color:white; font-size:20px; font-weight:bold; }
</style>
</head>
<body>

<div id="joystick"><div id="stick"></div></div>
<div id="shoot">FIRE</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>

<script>
// --- Escena ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

// --- Cámara FPS ---
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
camera.position.set(0,1.6,0);

// --- Renderer ---
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Luz
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(10,10,10);
scene.add(light);
scene.add(new THREE.AmbientLight(0x404040));

// Piso
const floor = new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshStandardMaterial({color:0x228B22}));
floor.rotation.x=-Math.PI/2;
scene.add(floor);

// --- Brazos con manos y dedos low-poly ---
const arms = new THREE.Group();

// Brazo izquierdo
const leftArm = new THREE.Mesh(new THREE.CylinderGeometry(0.07,0.07,0.5), new THREE.MeshStandardMaterial({color:0xffaa00}));
leftArm.rotation.z=Math.PI/8;
leftArm.position.set(-0.25,-0.3,-0.4);
arms.add(leftArm);

// Mano izquierda
const leftHand = new THREE.Mesh(new THREE.BoxGeometry(0.15,0.1,0.2), new THREE.MeshStandardMaterial({color:0xffaa00}));
leftHand.position.set(-0.25,-0.55,-0.4);
arms.add(leftHand);

// Dedos izquierda
for(let i=0;i<4;i++){
  const finger = new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.1), new THREE.MeshStandardMaterial({color:0xffaa00}));
  finger.rotation.x=Math.PI/2;
  finger.position.set(-0.25-0.03+0.02*i,-0.6,-0.35);
  arms.add(finger);
}

// Brazo derecho
const rightArm = new THREE.Mesh(new THREE.CylinderGeometry(0.07,0.07,0.5), new THREE.MeshStandardMaterial({color:0xffaa00}));
rightArm.rotation.z=-Math.PI/8;
rightArm.position.set(0.25,-0.3,-0.4);
arms.add(rightArm);

// Mano derecha
const rightHand = new THREE.Mesh(new THREE.BoxGeometry(0.15,0.1,0.2), new THREE.MeshStandardMaterial({color:0xffaa00}));
rightHand.position.set(0.25,-0.55,-0.4);
arms.add(rightHand);

// Dedos derecha
for(let i=0;i<4;i++){
  const finger = new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.1), new THREE.MeshStandardMaterial({color:0xffaa00}));
  finger.rotation.x=Math.PI/2;
  finger.position.set(0.25-0.03+0.02*i,-0.6,-0.35);
  arms.add(finger);
}

// --- Pistola con gatillo ---
const gun = new THREE.Group();
// Cuerpo
const gunBody = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.5), new THREE.MeshStandardMaterial({color:0x333333}));
gunBody.position.set(0,-0.25,-0.8);
gun.add(gunBody);
// Gatillo
const trigger = new THREE.Mesh(new THREE.BoxGeometry(0.02,0.05,0.05), new THREE.MeshStandardMaterial({color:0x111111}));
trigger.position.set(0,-0.3,-0.6);
gun.add(trigger);

arms.add(gun);
camera.add(arms);
scene.add(camera);

// Enemigo
const enemy = new THREE.Mesh(new THREE.BoxGeometry(0.5,1.5,0.5), new THREE.MeshStandardMaterial({color:0x0000ff}));
enemy.position.set(5,0.75,0);
scene.add(enemy);

// --- Movimiento joystick ---
let moveX=0, moveZ=0, speed=0.05;
const joystick=document.getElementById('joystick');
const stick=document.getElementById('stick');
let dragging=false,startX,startY;

joystick.addEventListener('pointerdown',e=>{dragging=true;startX=e.clientX;startY=e.clientY;});
window.addEventListener('pointermove',e=>{
  if(!dragging) return;
  let dx=e.clientX-startX, dy=e.clientY-startY;
  const max=40;
  dx=Math.max(-max,Math.min(max,dx));
  dy=Math.max(-max,Math.min(max,dy));
  stick.style.transform=`translate(${dx}px,${dy}px)`;
  moveX=dx/max;
  moveZ=-dy/max;
});
window.addEventListener('pointerup',e=>{dragging=false;stick.style.transform=`translate(0px,0px)`;moveX=0;moveZ=0;});

// --- Mirar cámara lado derecho ---
let lookActive=false,lastX,lastY;
document.body.addEventListener('pointerdown',e=>{if(e.clientX>window.innerWidth/2){lookActive=true;lastX=e.clientX;lastY=e.clientY;}});
document.body.addEventListener('pointermove',e=>{
  if(!lookActive) return;
  const dx=(e.clientX-lastX)*0.002;
  const dy=(e.clientY-lastY)*0.002;
  camera.rotation.y-=dx;
  camera.rotation.x-=dy;
  camera.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,camera.rotation.x));
  lastX=e.clientX; lastY=e.clientY;
});
document.body.addEventListener('pointerup',e=>{lookActive=false;});

// --- Disparo con bala visible ---
const bullets = [];
document.getElementById('shoot').addEventListener('pointerdown',()=>{
  const origin = new THREE.Vector3();
  camera.getWorldPosition(origin);
  const dir = new THREE.Vector3(0,0,-1).applyEuler(camera.rotation);

  // Crear bala (esfera)
  const bullet = new THREE.Mesh(new THREE.SphereGeometry(0.03), new THREE.MeshStandardMaterial({color:0xff0000}));
  bullet.position.copy(origin);
  bullet.userData = {dir: dir.clone()};
  scene.add(bullet);
  bullets.push(bullet);
});

// --- Animación ---
function animate(){
  requestAnimationFrame(animate);

  // Mover personaje relativo a cámara
  const forward = new THREE.Vector3(0,0,-1).applyEuler(camera.rotation).setY(0).normalize();
  const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), forward).normalize();
  camera.position.add(forward.multiplyScalar(moveZ*speed));
  camera.position.add(right.multiplyScalar(moveX*speed));

  // Actualizar balas
  for(let i=bullets.length-1;i>=0;i--){
    const b = bullets[i];
    b.position.add(b.userData.dir.clone().multiplyScalar(0.5));
    // Detectar colisión con enemigo
    const dist = b.position.distanceTo(enemy.position);
    if(dist<0.5){
      enemy.material.color.set(0xff0000);
      scene.remove(b);
      bullets.splice(i,1);
    } else if(b.position.length()>100){
      scene.remove(b);
      bullets.splice(i,1);
    }
  }

  renderer.render(scene,camera);
}
animate();

// Ajuste pantalla
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
